<?php
/**
 * @file
 * Hooks and helper functions for the cwrc_core_tweaks module.
 */

/* Hooks. */

/**
 * Implements hook_block_view_alter().
 */
function cwrc_core_tweaks_block_view_alter(&$data, $block) {
  if ($block->module === 'user' && $block->delta === 'online') {
    // Count users active within the defined period.
    $interval = REQUEST_TIME - variable_get('user_block_seconds_online', 900);

    // Perform database queries to gather online user lists. We use s.timestamp
    // rather than u.access because it is much faster.
    $authenticated_count = db_query("SELECT COUNT(DISTINCT s.uid) FROM {sessions} s WHERE s.timestamp >= :timestamp AND s.uid > 0", array(':timestamp' => $interval))->fetchField();

    // Append the badge to the subject.
    $data['subject'] .= ' <span class="badge">' . $authenticated_count . '</span>';
  }
}
