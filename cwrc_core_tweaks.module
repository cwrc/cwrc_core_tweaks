<?php
/**
 * @file
 * Hooks and helper functions for the cwrc_core_tweaks module.
 */

/* Hooks. */

/**
 * Implements hook_block_view_alter().
 */
function cwrc_core_tweaks_block_view_alter(&$data, $block) {
  if ($block->module === 'user' && $block->delta === 'online') {
    // Count users active within the defined period.
    $interval = REQUEST_TIME - variable_get('user_block_seconds_online', 900);

    // Perform database queries to gather online user lists. We use s.timestamp
    // rather than u.access because it is much faster.
    $authenticated_count = db_query("SELECT COUNT(DISTINCT s.uid) FROM {sessions} s WHERE s.timestamp >= :timestamp AND s.uid > 0", array(':timestamp' => $interval))->fetchField();

    // Append the badge to the subject.
    $data['subject'] .= ' <span class="badge">' . $authenticated_count . '</span>';
  }
}

/**
 * Implements hook_menu_breadcrumb_alter().
 */
function cwrc_core_tweaks_menu_breadcrumb_alter(&$active_trail, $item) {
  // Change the title of breadcrumb items linking to the front page from "Home"
  // to "CWRC" to avoid confusion with project homepages.
  // We must check that there _are_ breadcrumbs first, as the front page notably
  // does not display them.
  if (!empty($active_trail)) {
    foreach ($active_trail as &$breadcrumb) {
      if ($breadcrumb['href'] === '<front>') {
        $breadcrumb['title'] = t('CWRC');
      }
    }
  }
}

/**
 * Implements hook_islandora_breadcrumbs_alter().
 *
 * @param array &$breadcrumbs
 *   An array of breadcrumbs.
 * @param string $context
 *   A context string.
 * @param IslandoraFedoraObject $object
 *   The Fedora object.
 */
function cwrc_core_tweaks_islandora_breadcrumbs_alter(&$breadcrumbs, $context, $object = NULL) {
  $front_page_path = url('<front>');

  // Loop through each breadcrumb. If it points to the front page, modify the
  // link text. Note that the breadcrumb comes pre-rendered to HTML with
  // already-translated strings, so we have to preg_replace() the already-
  // translated string with a different already-translated string. This is not
  // ideal, but Islandora doesn't really provide us with any better options
  // unless we patch the Islandora core module. Note also that we use the
  // Ungreedy pattern modifier for convenience.
  foreach ($breadcrumbs as &$breadcrumb) {
    if (_cwrc_menu_links_points_to_path($breadcrumb, $front_page_path)) {
      preg_replace('/' . t('Home') . '/U', t('CWRC'), $breadcrumb);
    }
  }
}
